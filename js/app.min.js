var Triviarport=Triviarport||{};Array.prototype.get_random=function(){var a=Math.floor(Math.random()*this.length);return this[a]};String.prototype.format=String.prototype.f=function(){var b=this,a=arguments.length;while(a--){b=b.replace(new RegExp("\\{"+a+"\\}","gm"),arguments[a])}return b};function Timer(f,g){var d,b=false;function a(k,j){return j?j-k:new Date().getTime()-k}function h(){clearTimeout(d)}function i(){clearTimeout(d);total_time_run=a(e);b=total_time_run>=g}function c(){d=b?-1:setTimeout(f,g-total_time_run)}var e=new Date().getTime();d=setTimeout(f,g);return{cancel:h,pause:i,resume:c}}function AirportriviaUser(){this.airport_history=[];this.wrong_attempt_count=0;this.current_round_points=80;this.score=0;this.updateRoundPoints=function(){$("#score-board-round-points").text(this.current_round_points)};this.updateScore=function(){$("#score-board-score").text(this.score)}}var airport_data_adapter=new AirportDataAdapter();var current_user=new AirportriviaUser();var current_airport;var map;function show_airport_on_map(c){var b=new google.maps.LatLng(c.latitude,c.longitude);var a={center:b,zoom:c.initial_zoom_level,mapTypeId:google.maps.MapTypeId.SATELLITE,disableDefaultUI:true,draggable:false,zoomControl:false,scrollwheel:false,disableDoubleClickZoom:true};map=new google.maps.Map(document.getElementById("googleMap"),a);map.airport=c;current_user.current_round_points=80;current_user.updateRoundPoints();map.zoom_out=function(){if(map.getZoom()>3){var e=map.getZoom()-1;if(e==5||e==10){e--}map.setZoom(e);if(map.getZoom()==12){var d=new google.maps.Marker({position:b,map:map,icon:"images/airport_icon_marker_small.png"})}if(map.getZoom()>=7){current_user.current_round_points-=5}else{current_user.current_round_points-=10}current_user.updateRoundPoints();map.zoom_out_thread=new Timer(map.zoom_out,5000)}else{setTimeout(function(){current_user.wrong_attempt_count++;current_user.current_round_points=0;current_user.updateRoundPoints();showTooLateResolutionModal()},10000)}};map.zoom_out_thread=new Timer(map.zoom_out,6000);return map}function prepare_resolution_modal_for(a){$("#resolutionModal").removeClass("success");$("#resolutionModal").removeClass("error");$(".modal-airport-description-short").each(function(){$(this).html("{0} (IATA: {1}) in {2}.".format(a.name,a.iata_code,a.city))});$(".modal-airport-description").each(function(){$(this).html(a.description_text+" "+$(".modal-airport-wikipedia-link")[0].outerHTML)});$(".modal-airport-description-mobile").each(function(){$(this).html("This airport is {0} (IATA: {1}) in {2}. {3}".format(a.name,a.iata_code,a.city,$(".modal-airport-wikipedia-link")[0].outerHTML))});$(".modal-airport-wikipedia-link").each(function(){$(this).attr("href",a.wikipedia_url)});$(".modal-airport-google-maps").each(function(){$(this).attr("href","https://maps.google.com/maps?ll={0},{1}&t=k&z={2}".format(a.latitude,a.longitude,a.initial_zoom_level))})}function focus_airport_answer_input(){setTimeout(function(){$("#airport_answer").focus()},0)}function reset_page_for_new_airport(){$("#airport_answer").val("");$("#airport_answer").attr("placeholder","Guess the airport's name, IATA or city")}google.maps.event.addDomListener(window,"load",function(){$("form").submit(false);current_airport=airport_data_adapter.get_random_airport();var a=show_airport_on_map(current_airport);$("#helpModal").on("show.bs.modal",function(b){a.zoom_out_thread.pause()});$("#helpModal").on("shown.bs.modal",function(b){$("#button-help-modal-dismiss").focus()});$("#helpModal").modal("show");$("#helpModal").on("hidden.bs.modal",function(b){if(typeof(Storage)!=="undefined"){localStorage.airportrivia_newbee=false}focus_airport_answer_input();a.zoom_out_thread.resume()});prepare_resolution_modal_for(current_airport);$("#resolutionModal").on("show.bs.modal",function(b){a.zoom_out_thread.cancel()});$("#resolutionModal").on("shown.bs.modal",function(b){$("#button-resolution-modal-dismiss").focus()});$("#resolutionModal").on("hide.bs.modal",function(b){$("#airport-answer-form").removeClass("has-error");$("#airport-answer-form").removeClass("has-success");if($("#score-life-{0}".format(current_user.wrong_attempt_count)).hasClass("losing")){$("#score-life-{0}".format(current_user.wrong_attempt_count)).removeClass("losing");$("#score-life-{0}".format(current_user.wrong_attempt_count)).addClass("lost")}});$("#resolutionModal").on("hidden.bs.modal",function(b){reset_page_for_new_airport();current_airport=airport_data_adapter.get_random_airport();a=show_airport_on_map(current_airport);focus_airport_answer_input();current_user.updateScore();prepare_resolution_modal_for(current_airport)});$("#game-over-modal").on("shown.bs.modal",function(b){$("#button-game-over-modal-dismiss").focus()})});function check(){var e=document.getElementById("airport_answer").value.trim();if(e==undefined||e==""||e.length>100){return}if(current_airport.iata_code.toLowerCase()==e.toLowerCase()||new Levenshtein(e.toLowerCase(),current_airport.city.toLowerCase()).distance<=1){show_positive_resolution_dialog();return}for(var d=0;d<current_airport.optional_keywords.length;d++){var a=current_airport.optional_keywords[d];if(new Levenshtein(e.toLowerCase(),a.toLowerCase()).distance<=1){show_positive_resolution_dialog();return}else{var c=e.split(" ");for(var b=0;b<c.length;b++){if(new Levenshtein(c[b].trim().toLowerCase(),a.toLowerCase()).distance<=1){show_positive_resolution_dialog();return}}}}current_user.wrong_attempt_count++;current_user.current_round_points=0;current_user.updateRoundPoints();if(current_user.wrong_attempt_count<3){show_negative_resolution_dialog();return}show_game_over_dialog()}function show_game_over_dialog(){map.zoom_out_thread.cancel();$("#airport_answer").blur();$("#game-over-modal-final-score").text("{0} Points".format(current_user.score));$("#game-over-modal").addClass("error");$("#game-over-modal").modal("show");$("#airport-answer-form").toggleClass("has-error");$("#score-life-{0}".format(current_user.wrong_attempt_count)).toggleClass("losing")}var motivationals=Array("Off by one!","Too bad!","Keep working on it!","Not this time!","You can do better!");function show_negative_resolution_dialog(){map.zoom_out_thread.cancel();$("#airport_answer").blur();$("#airport-answer-form").toggleClass("has-error");$("#resolution-modal-outcome").html('No Points and &mdash;<span class="glyphicon glyphicon-heart" style="top: 3px;"></span>');$("#score-life-{0}".format(current_user.wrong_attempt_count)).toggleClass("losing");$("#resolutionModalTitle").text(motivationals.get_random());$("#resolutionModal").addClass("error");$("#resolutionModal").modal("show")}function showTooLateResolutionModal(){map.zoom_out_thread.cancel();$("#airport_answer").blur();$("#airport-answer-form").toggleClass("has-error");$("#score-life-{0}".format(current_user.wrong_attempt_count)).toggleClass("losing");$("#resolution-modal-outcome").html('No Points and &mdash;<span class="glyphicon glyphicon-heart" style="top: 3px;"></span>');$("#resolutionModalTitle").text(motivationals.get_random());$("#resolutionModal").addClass("error");$("#resolutionModal").modal("show")}var celebrations=Array("Nice done!","Good job!","Outstanding!","Spectacular!","Great!","Awesome!");function show_positive_resolution_dialog(){map.zoom_out_thread.cancel();$("#airport_answer").blur();current_user.score+=current_user.current_round_points;$("#resolution-modal-outcome").text("+{0} Points".format(current_user.current_round_points));$("#resolutionModalTitle").text(celebrations.get_random());$("#airport-answer-form").toggleClass("has-success");$("#resolutionModal").addClass("success");$("#resolutionModal").modal("show")};